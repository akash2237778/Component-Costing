<!DOCTYPE html>
<html lang="en">
<head>
    <title>Sai Precision Quoter</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .table-container { overflow-x: auto; }
        input { transition: all 0.2s; }
        input:focus { outline: 2px solid #2563EB; background: #EFF6FF; }
        
        /* Sticky Column Logic */
        th:first-child, td:first-child { position: sticky; left: 0; background-color: white; z-index: 10; }
        thead th:first-child { background-color: #1e293b; z-index: 20; }
        
        /* Sticky Footer Logic */
        tfoot th:first-child, tfoot td:first-child { position: sticky; left: 0; z-index: 20; }
        tfoot { position: sticky; bottom: 0; z-index: 20; }
        
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 font-sans h-screen flex flex-col">

    <div class="p-4 bg-white shadow flex justify-between items-center z-30 relative">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-slate-800">PrecisionQuote v1.0</h1>
            
            {{ if .IsAdmin }}
            <a href="/settings" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 px-3 py-1 rounded flex items-center gap-1 transition">
                <span>‚öôÔ∏è Settings</span>
            </a>
            {{ end }}
            <a href="/history" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 border border-blue-300 px-3 py-1 rounded flex items-center gap-1 transition"><span>üìú History</span></a>
        </div>

        <div class="flex items-center gap-6">
            <div class="text-sm bg-blue-50 text-blue-800 px-3 py-1 rounded border border-blue-200 hidden md:block">
                <strong>Active Rates:</strong> 
                CNC ‚Çπ{{ .Rates.CNCRate }} | 
                Sq ‚Çπ{{ .Rates.SquaringRate }} | 
                Wire ‚Çπ{{ .Rates.WireCutRate }} |
                H/T ‚Çπ{{ .Rates.HTRate }}
            </div>

            <div class="flex items-center gap-3 border-l-2 border-gray-200 pl-4">
                <span class="text-sm font-bold text-slate-700 capitalize">{{ .User }}</span>
                <a href="/logout" class="text-xs text-red-500 hover:text-red-700 font-bold uppercase tracking-wide">Logout</a>
            </div>
        </div>
    </div>

    <div class="px-6 py-4 bg-gray-50 border-b flex gap-4 items-center">
        
        <input type="hidden" id="quote_number" value="{{ .QuoteNumber }}"> <input type="hidden" id="is-load-mode" value="{{ .IsLoadMode }}">

        {{ if .QuoteNumber }}
        <div class="bg-blue-100 text-blue-800 px-3 py-2 rounded font-bold border border-blue-300 shadow-sm">
            #{{ .QuoteNumber }} <span class="text-xs text-blue-600 bg-white px-1 rounded ml-1 border">v{{ .Version }}</span>
        </div>
        {{ end }}

        {{ if .IsAdmin }}
            <input type="text" id="customer_name" placeholder="Customer Name" value="{{ .CustomerName }}" 
                   class="border p-2 rounded w-64 shadow-sm" oninput="saveDraft()">
        {{ else }}
            <div class="border p-2 rounded w-64 shadow-sm bg-gray-100 text-gray-400 italic cursor-not-allowed flex items-center px-3">
                üîí Customer Hidden
            </div>
            <input type="hidden" id="customer_name" value=""> 
        {{ end }}

        <input type="text" id="tool_name" placeholder="Tool Name / Description" value="{{ .ToolName }}" 
               class="border p-2 rounded w-96 shadow-sm" oninput="saveDraft()">
        
        <span class="text-xs text-green-600 font-bold transition-opacity duration-500 opacity-0" id="save-indicator">‚úì Draft Saved</span>
    </div>

    <div class="flex-grow p-4 overflow-hidden">
        <div class="bg-white shadow-xl rounded-lg border border-gray-200 table-container h-full overflow-y-auto">
            <table class="min-w-full text-sm border-collapse relative" id="quote-table">
                <thead class="bg-slate-800 text-white sticky top-0 z-20 shadow-md">
                    <tr>
                        <th class="p-3 text-left w-48 border-r border-slate-600">Component</th>
                        <th class="p-3 text-left w-32 border-r border-slate-600">Material</th>
                        <th class="p-3 text-center w-16">L (mm)</th>
                        <th class="p-3 text-center w-16">W (mm)</th>
                        <th class="p-3 text-center w-16 border-r border-slate-600">H (mm)</th>
                        
                        <th class="p-3 text-center bg-yellow-600 w-20 text-white font-bold border-r border-yellow-700">Wt (kg)</th>
                        <th class="p-3 text-center bg-yellow-600 w-20 text-white font-bold border-r border-yellow-700">Sq Area</th>
                        <th class="p-3 text-center bg-orange-600 w-24 text-white font-bold border-r border-slate-600">Pre-Mach (‚Çπ)</th>
                        <th class="p-3 text-center bg-red-600 w-20 text-white font-bold border-r border-slate-600">H/T (‚Çπ)</th>
                        
                        <th class="p-3 text-center bg-slate-700 w-24">CNC (Hr)</th>
                        <th class="p-3 text-center bg-slate-700 w-24">Wire (mm)</th>
                        <th class="p-3 text-center bg-slate-700 w-24 border-r border-slate-600">Drilling (‚Çπ)</th>
                        
                        <th class="p-3 text-center w-16 border-r border-slate-600">Qty</th>
                        <th class="p-3 text-right font-bold bg-green-900 w-32 text-white">Total / Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200" id="rows-body">
                    {{ range .Components }}
                    <tr class="hover:bg-gray-50 transition item-row">
                        
                        <td class="p-2 font-medium text-gray-700 border-r shadow-sm">
                            <input type="text" class="row-name bg-transparent font-medium w-full" value="{{ .Name }}" readonly>
                            <form id="row-form-{{ .ID }}">
                                <input type="hidden" name="component_id" value="{{ .ID }}">
                                <input type="hidden" name="shape" value="{{ .Shape }}">
                            </form>
                        </td>
                        
                        {{ if eq .Shape "Fixed" }}
                            <td colspan="4" class="p-1 border-r bg-gray-50 text-center text-gray-400 text-xs italic">Standard Item</td>
                            <td colspan="3" class="p-1 border-r bg-white">
                                <input type="number" step="1" name="manual_price" placeholder="Unit Price ‚Çπ" value="{{ if .ManualPrice }}{{ .ManualPrice }}{{ end }}" form="row-form-{{ .ID }}" 
                                       class="row-manual-price w-full border-2 border-blue-200 rounded p-1 text-center font-bold text-blue-800"
                                       oninput="saveDraft()"
                                       hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                            </td>
                            <td class="bg-gray-50"></td> <td class="bg-gray-50"></td> <td class="bg-gray-50"></td> <td class="bg-gray-50 border-r"></td>
                        {{ else }}
                            <td class="p-1 border-r">
                                <select name="material_id" form="row-form-{{ .ID }}" class="row-material w-full border rounded p-1 text-xs bg-white"
                                        onchange="saveDraft()"
                                        hx-post="/calculate" hx-trigger="change" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                                    <option value="0">Select...</option>
                                    {{ $currMat := .MaterialID }}
                                    {{ range $.Materials }}
                                        <option value="{{ .ID }}" {{ if eq .ID $currMat }}selected{{ end }}>{{ .Name }}</option>
                                    {{ end }}
                                </select>
                            </td>
                            <td class="p-1"><input type="number" name="length" placeholder="L" value="{{ if .Length }}{{ .Length }}{{ end }}" class="row-length w-full border rounded p-1 text-center" oninput="saveDraft()" form="row-form-{{ .ID }}" hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}"></td>
                            <td class="p-1"><input type="number" name="width" placeholder="W" value="{{ if .Width }}{{ .Width }}{{ end }}" class="row-width w-full border rounded p-1 text-center" oninput="saveDraft()" form="row-form-{{ .ID }}" hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}"></td>
                            <td class="p-1 border-r"><input type="number" name="height" placeholder="H" value="{{ if .Height }}{{ .Height }}{{ end }}" class="row-height w-full border rounded p-1 text-center" oninput="saveDraft()" form="row-form-{{ .ID }}" hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}"></td>
                            
                            <td class="p-2 text-center text-gray-500 bg-gray-50 font-mono text-xs border-r">
                                <div id="weight-div-{{ .ID }}">{{ if .Weight }}{{ printf "%.2f" .Weight }} kg{{ else }}-{{ end }}</div>
                            </td>
                            <td class="p-2 text-center text-gray-500 bg-gray-50 font-mono text-xs border-r">
                                <div id="area-div-{{ .ID }}">{{ if .Area }}{{ printf "%.1f" .Area }} sq"{{ else }}-{{ end }}</div>
                            </td>
                            
                            <td class="p-2 text-center bg-orange-50 border-r align-middle">
                                <div class="flex flex-col items-center">
                                    <input type="checkbox" name="include_squaring" value="true" {{ if .IncludeSquaring }}checked{{ end }} 
                                           onchange="saveDraft()" form="row-form-{{ .ID }}" 
                                           hx-post="/calculate" hx-trigger="change" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                                    <div id="pre-mach-div-{{ .ID }}" class="text-xs font-bold text-orange-800">
                                        {{ if .PreMachCost }}‚Çπ{{ printf "%.0f" .PreMachCost }}{{ else }}-{{ end }}
                                    </div>
                                </div>
                            </td>

                            <td class="p-2 text-center bg-red-50 border-r align-middle">
                                <div class="flex flex-col items-center">
                                    <input type="checkbox" name="include_ht" value="true" {{ if .IncludeHT }}checked{{ end }} 
                                           onchange="saveDraft()" form="row-form-{{ .ID }}" 
                                           hx-post="/calculate" hx-trigger="change" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                                    <div id="ht-div-{{ .ID }}" class="text-xs font-bold text-red-800">
                                        {{ if .HTCost }}‚Çπ{{ printf "%.0f" .HTCost }}{{ else }}-{{ end }}
                                    </div>
                                </div>
                            </td>

                            <td class="p-1 bg-white">
                                <input type="number" name="cnc_hours" placeholder="Hrs" class="w-full border rounded p-1 text-center" oninput="saveDraft()" form="row-form-{{ .ID }}" hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                                <div id="cnc-cost-div-{{ .ID }}" class="text-xs text-center text-gray-400 font-mono">-</div>
                            </td>
                            <td class="p-1 bg-white">
                                <input type="number" name="wirecut_len" placeholder="mm" class="w-full border rounded p-1 text-center" oninput="saveDraft()" form="row-form-{{ .ID }}" hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                                <div id="wire-cost-div-{{ .ID }}" class="text-xs text-center text-gray-400 font-mono">-</div>
                            </td>
                            <td class="p-1 border-r bg-white">
                                <input type="number" name="drilling_cost" placeholder="‚Çπ" class="w-full border rounded p-1 text-center" oninput="saveDraft()" form="row-form-{{ .ID }}" hx-post="/calculate" hx-trigger="keyup delay:400ms changed" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                            </td>
                        {{ end }}

                        <td class="p-1 border-r bg-white">
                            <input type="number" name="quantity" value="{{ if .Quantity }}{{ .Quantity }}{{ else }}1{{ end }}" 
                                   class="row-qty w-full border rounded p-1 text-center font-bold text-blue-600" 
                                   oninput="saveDraft()" form="row-form-{{ .ID }}" 
                                   hx-post="/calculate" hx-trigger="change, input delay:300ms" hx-include="#row-form-{{ .ID }}" hx-target="#cost-val-{{ .ID }}">
                        </td>

                        <td class="p-2 text-right font-bold text-green-700 bg-green-50 shadow-inner flex flex-col justify-between h-full min-h-[60px]">
                            <span id="cost-val-{{ .ID }}" class="row-total block mb-1">
                                {{ if .RowCost }}‚Çπ{{ printf "%.2f" .RowCost }}{{ else }}‚Çπ0.00{{ end }}
                            </span>
                            <button hx-delete="/component/remove" hx-target="closest tr" hx-swap="outerHTML" 
                                    class="text-[10px] text-red-400 hover:text-red-600 uppercase tracking-wider font-semibold self-end">
                                Remove ‚úï
                            </button>
                        </td>
                    </tr>
                    {{ end }}
                </tbody>
                
                <tfoot class="bg-slate-800 text-white shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
                    <tr>
                        <td colspan="10" class="p-4 bg-slate-800 border-t-2 border-slate-600">
                             <button hx-get="/component/add" hx-target="#rows-body" hx-swap="beforeend"
                                     class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow flex items-center gap-2 text-sm font-bold">
                                <span>‚ûï Add Custom Component</span>
                            </button>
                        </td>
                        <td colspan="3" class="p-4 text-right bg-slate-800 border-t-2 border-slate-600">
                            <button onclick="saveQuote()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded shadow text-lg font-bold w-full transition transform hover:scale-105">
                                üíæ Save Quote
                            </button>
                        </td>
                        <td class="p-4 text-right font-bold text-2xl text-green-400 border-t-2 border-slate-600 bg-slate-900 min-w-[150px]">
                            <span id="grand-total-display">‚Çπ0.00</span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <script>
        const DRAFT_KEY = "precision_quote_draft";

        // 1. SAVE DRAFT
        function saveDraft() {
            if (document.getElementById('is-load-mode').value === "true") return;

            const draft = {
                customer: document.getElementById('customer_name').value,
                tool: document.getElementById('tool_name').value,
                rows: {}
            };

            const inputs = document.querySelectorAll('input[form^="row-form-"], select[form^="row-form-"]');
            
            inputs.forEach(input => {
                if (input.name && input.form) {
                    const key = input.form.id + "__" + input.name;
                    if(input.type === 'checkbox') {
                        draft.rows[key] = input.checked;
                    } else {
                        draft.rows[key] = input.value;
                    }
                }
            });

            localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
            
            const indicator = document.getElementById('save-indicator');
            indicator.style.opacity = '1';
            setTimeout(() => indicator.style.opacity = '0', 800);
        }

        // 2. RESTORE DRAFT
        function restoreDraft() {
            if (document.getElementById('is-load-mode').value === "true") return;

            const raw = localStorage.getItem(DRAFT_KEY);
            if (!raw) return;

            const draft = JSON.parse(raw);
            if(draft.customer) document.getElementById('customer_name').value = draft.customer;
            if(draft.tool) document.getElementById('tool_name').value = draft.tool;

            Object.keys(draft.rows).forEach(key => {
                const parts = key.split("__");
                if(parts.length < 2) return;
                
                const formId = parts[0];   
                const inputName = parts[1];
                const selector = `[form="${formId}"][name="${inputName}"]`;
                const input = document.querySelector(selector);
                
                if (input) {
                    if(input.type === 'checkbox') {
                        input.checked = draft.rows[key];
                    } else {
                        input.value = draft.rows[key];
                    }
                }
            });

            // Trigger Recalculation
            const uniqueForms = new Set();
            Object.keys(draft.rows).forEach(key => uniqueForms.add(key.split("__")[0]));
            
            uniqueForms.forEach(formId => {
                const triggerSelector = `[form="${formId}"][name="length"], [form="${formId}"][name="manual_price"]`;
                const trigger = document.querySelector(triggerSelector);
                if(trigger && trigger.value) {
                    htmx.trigger(trigger, 'change');
                }
            });
        }

        function updateGrandTotal() {
            let total = 0.0;
            document.querySelectorAll('.row-total').forEach(row => {
                const val = parseFloat(row.innerText.replace(/[^\d.-]/g, ''));
                if (!isNaN(val)) total += val;
            });
            document.getElementById('grand-total-display').innerText = total.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 2 });
        }

        async function saveQuote() {
            const customer = document.getElementById('customer_name').value;
            const tool = document.getElementById('tool_name').value;
            const quoteNum = parseInt(document.getElementById('quote_number').value) || 0;
            
            if(!tool) {
                alert("Please enter Tool Name");
                return;
            }

            const items = [];
            document.querySelectorAll('.item-row').forEach(row => {
                const name = row.querySelector('.row-name').value;
                const costText = row.querySelector('.row-total').innerText.replace(/[^\d.-]/g, '');
                
                if (parseFloat(costText) > 0) {
                    const formIdInput = row.querySelector('input[name="component_id"]');
                    if(!formIdInput) return;
                    const formId = formIdInput.form.id;

                    const getVal = (name) => {
                        const el = document.querySelector(`[form="${formId}"][name="${name}"]`);
                        return el ? el.value : null;
                    };
                    const getCheck = (name) => {
                        const el = document.querySelector(`[form="${formId}"][name="${name}"]`);
                        return el ? el.checked : false;
                    };

                    items.push({
                        component_name: name,
                        shape: getVal('shape') || "Cuboid",
                        material_id: parseInt(getVal('material_id')) || 0,
                        length: parseFloat(getVal('length')) || 0,
                        width: parseFloat(getVal('width')) || 0,
                        height: parseFloat(getVal('height')) || 0,
                        manual_price: parseFloat(getVal('manual_price')) || 0,
                        quantity: parseInt(getVal('quantity')) || 1,
                        row_cost: parseFloat(costText),
                        include_squaring: getCheck('include_squaring'),
                        include_ht: getCheck('include_ht')
                    });
                }
            });

            if (items.length === 0) {
                alert("No items to save (Total is 0)!");
                return;
            }

            const grandTotalText = document.getElementById('grand-total-display').innerText.replace(/[^\d.-]/g, '');

            const payload = {
                quote_number: quoteNum,
                customer_name: customer,
                tool_name: tool,
                grand_total: parseFloat(grandTotalText),
                items: items
            };

            const res = await fetch('/quotes/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await res.json();

            if (res.ok) {
                localStorage.removeItem(DRAFT_KEY);
                window.location.href = "/history";
            } else {
                // Show specific error message from server
                alert("Save Failed: " + (data.error || "Unknown Error"));
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            setTimeout(restoreDraft, 150);
            updateGrandTotal();
        });
        document.body.addEventListener('htmx:afterSwap', updateGrandTotal);
    </script>
</body>
</html>